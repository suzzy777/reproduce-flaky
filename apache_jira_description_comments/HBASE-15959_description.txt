It flakes [here|https://github.com/apache/hbase/blob/b557f0bec62a48753e5d01d7a47f3c9e5a6b3ee8/hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java#L460].
There are two weird things i identified:
1. In second compaction, [scanner|https://github.com/apache/hbase/blob/b557f0bec62a48753e5d01d7a47f3c9e5a6b3ee8/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/DefaultMobStoreCompactor.java#L173] has 10 storefiles. Shouldn't there be 6? 5 from recent flushes and 1 from earlier compaction. Probably because mob cleaner doesn't clean old hfiles. Does this needs fixing?
2. Across runs, same cell (ie. same key) may or may not be considered mob reference cell. [here|https://github.com/apache/hbase/blob/b557f0bec62a48753e5d01d7a47f3c9e5a6b3ee8/hbase-server/src/main/java/org/apache/hadoop/hbase/mob/DefaultMobStoreCompactor.java#L213]. This at least happens with row keys 0 - 4 (which got compacted earlier). [~jmhsieh] Any ideas why this would happen.