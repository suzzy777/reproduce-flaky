Hi [~boroknagyz], assigned this JIRA to you since you were the author of the E2E test.

Please re-assign the ticket as you see appropriate. Thanks!


Hive created the following files for alltypes_promoted_orc_def:
{noformat}
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=1
-rw-r--r--   3 ubuntu supergroup       1810 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=1/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=10
-rw-r--r--   3 ubuntu supergroup       1836 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=10/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=11
-rw-r--r--   3 ubuntu supergroup       1825 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=11/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=12
-rw-r--r--   3 ubuntu supergroup       1846 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=12/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=2
-rw-r--r--   3 ubuntu supergroup       1823 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=2/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=3
-rw-r--r--   3 ubuntu supergroup       1840 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=3/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=4
-rw-r--r--   3 ubuntu supergroup       1832 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=4/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=5
-rw-r--r--   3 ubuntu supergroup       1845 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=5/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=6
-rw-r--r--   3 ubuntu supergroup       1832 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=6/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=7
-rw-r--r--   3 ubuntu supergroup       1845 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=7/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=8
-rw-r--r--   3 ubuntu supergroup       1840 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=8/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=9
-rw-r--r--   3 ubuntu supergroup       1831 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2009/month=9/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=1
-rw-r--r--   3 ubuntu supergroup       1835 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=1/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=10
-rw-r--r--   3 ubuntu supergroup       1834 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=10/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=11
-rw-r--r--   3 ubuntu supergroup       1825 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=11/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=12
-rw-r--r--   3 ubuntu supergroup       1834 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=12/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=2
-rw-r--r--   3 ubuntu supergroup       1816 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=2/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=3
-rw-r--r--   3 ubuntu supergroup       1841 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=3/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=4
-rw-r--r--   3 ubuntu supergroup       1826 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=4/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=5
-rw-r--r--   3 ubuntu supergroup       1839 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=5/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=6
-rw-r--r--   3 ubuntu supergroup       1826 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=6/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=7
-rw-r--r--   3 ubuntu supergroup       1839 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=7/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=8
-rw-r--r--   3 ubuntu supergroup       1839 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=8/000000_1
drwxr-xr-x   - ubuntu supergroup          0 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=9
-rw-r--r--   3 ubuntu supergroup       1826 2022-06-09 01:04 /test-warehouse/alltypes_promoted_orc_def/year=2010/month=9/000000_1
{noformat}

All of them having '_1' suffixes. Since there's only one file in the directories, they should have '_0' suffixes. Probably there was some error during the insertion and Hive had to retry the operation, hence it wrote files with an incremented sequence id.

Impala has the assumption that '_1'  means multiple files in a bucket (because there must be a '_0' it thinks), and currently we cannot generate row ids for this case:
https://github.com/apache/impala/blob/1285fc95ad237f18ff46f5c1d259e004058bbd6e/be/src/exec/hdfs-orc-scanner.cc#L377

The best would be to make Hive create files with '_0' suffixes in case of errors.

Resolving this as we haven't seen this in a while. This happens when Hive table loading fails.
Also, we don't plan to support multiple original files in a single bucket.

