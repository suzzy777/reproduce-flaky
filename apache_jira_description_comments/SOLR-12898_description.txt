I've done a lot of this on the starburst branch and then again did some in a related test issue. This issue is to finish comprehensibly and pull everything from starburst around this in.