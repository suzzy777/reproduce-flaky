when default branch is executed in switch(op->type) , alloced memory for oa variable will leak, so, close_buffer_oarchive(&oa, 1); should be called before returning in default branch.