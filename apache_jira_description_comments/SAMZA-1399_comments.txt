This part of the tests has been rewritten significantly.

