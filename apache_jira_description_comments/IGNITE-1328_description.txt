Please look at IgniteUtils starting line 320