Test is flaky.

Also there is always failing test in suite: TxOptimisticDeadlockDetectionTest.testDeadlocksPartitionedNear

TC build result: http://ci.ignite.apache.org/viewLog.html?buildId=744109&tab=buildResultsDiv&buildTypeId=Ignite20Tests_IgniteCacheDeadlockDetection

Stacktrace: 

{noformat}
[2017-07-28 03:31:52,827][ERROR][grid-timeout-worker-#31%transactions.TxOptimisticDeadlockDetectionTest0%][IgniteTxHandler] Failed to prepare DHT transaction: GridDhtTxLocal [nearNodeId=d005de76-4378-4cd5-ad7e-f00593a00002, nearFutId=aab9f378d51-37ca90c9-03f5-417c-9731-2c29810e3cc0, nearMiniId=1, nearFinFutId=null, nearFinMiniId=0, nearXidVer=GridCacheVersion [topVer=112692678, order=1501212673293, nodeOrder=3], super=GridDhtTxLocalAdapter [nearOnOriginatingNode=false, nearNodes=[], dhtNodes=[], explicitLock=false, super=IgniteTxLocalAdapter [completedBase=null, sndTransformedVals=false, depEnabled=false, txState=IgniteTxStateImpl [activeCacheIds=GridIntList [idx=1, arr=[94416770]], recovery=false, txMap=[IgniteTxEntry [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=424974513, hash=-1228408719, id=1, name=KeyObject1], cacheId=94416770, txKey=IgniteTxKey [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=424974513, hash=-1228408719, id=1, name=KeyObject1], cacheId=94416770], val=[op=CREATE, val=CacheObjectImpl [val=null, hasValBytes=true]], prevVal=[op=NOOP, val=null], oldVal=[op=NOOP, val=null], entryProcessorsCol=null, ttl=-1, conflictExpireTime=-1, conflictVer=null, explicitVer=null, dhtVer=null, filters=[], filtersPassed=false, filtersSet=false, entry=GridDhtCacheEntry [rdrs=[], part=694, super=GridDistributedCacheEntry [super=GridCacheMapEntry [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=16030069, hash=-1228408719, id=1, name=KeyObject1], val=null, startVer=1501212673290, ver=GridCacheVersion [topVer=112692678, order=1501212673290, nodeOrder=1], hash=-1228408719, extras=GridCacheMvccEntryExtras [mvcc=GridCacheMvcc [locs=[GridCacheMvccCandidate [nodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, ver=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], threadId=846, id=520, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], reentry=null, otherNodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, otherVer=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], mappedDhtNodes=null, mappedNearNodes=null, ownerVer=null, serOrder=null, key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=16030069, hash=-1228408719, id=1, name=KeyObject1], masks=local=1|owner=1|ready=1|reentry=0|used=0|tx=1|single_implicit=0|dht_local=1|near_local=0|removed=0|read=0, prevVer=null, nextVer=null], GridCacheMvccCandidate [nodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, ver=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], threadId=847, id=521, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], reentry=null, otherNodeId=d005de76-4378-4cd5-ad7e-f00593a00002, otherVer=GridCacheVersion [topVer=112692678, order=1501212673293, nodeOrder=3], mappedDhtNodes=null, mappedNearNodes=null, ownerVer=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], serOrder=null, key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=16030069, hash=-1228408719, id=1, name=KeyObject1], masks=local=1|owner=0|ready=1|reentry=0|used=0|tx=1|single_implicit=0|dht_local=1|near_local=0|removed=0|read=0, prevVer=null, nextVer=null]], rmts=null]], flags=2]]], prepared=1, locked=false, nodeId=null, locMapped=false, expiryPlc=null, transferExpiryPlc=false, flags=0, partUpdateCntr=0, serReadVer=null, xidVer=null]]], super=IgniteTxAdapter [xidVer=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], writeVer=null, implicit=false, loc=true, threadId=847, startTime=1501212712015, nodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, startVer=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], endVer=null, isolation=REPEATABLE_READ, concurrency=OPTIMISTIC, timeout=800, sysInvalidate=false, sys=false, plc=2, commitVer=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], finalizing=NONE, invalidParts=null, state=MARKED_ROLLBACK, timedOut=false, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], duration=808ms, onePhaseCommit=false], size=1]]]
class org.apache.ignite.internal.transactions.IgniteTxTimeoutCheckedException: Failed to acquire lock within provided timeout for transaction [timeout=800, tx=GridDhtTxLocal [nearNodeId=d005de76-4378-4cd5-ad7e-f00593a00002, nearFutId=aab9f378d51-37ca90c9-03f5-417c-9731-2c29810e3cc0, nearMiniId=1, nearFinFutId=null, nearFinMiniId=0, nearXidVer=GridCacheVersion [topVer=112692678, order=1501212673293, nodeOrder=3], super=GridDhtTxLocalAdapter [nearOnOriginatingNode=false, nearNodes=[], dhtNodes=[], explicitLock=false, super=IgniteTxLocalAdapter [completedBase=null, sndTransformedVals=false, depEnabled=false, txState=IgniteTxStateImpl [activeCacheIds=GridIntList [idx=1, arr=[94416770]], recovery=false, txMap=[IgniteTxEntry [key=org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=424974513, hash=-1228408719, id=1, name=KeyObject1], cacheId=94416770, txKey=IgniteTxKey [key=org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=424974513, hash=-1228408719, id=1, name=KeyObject1], cacheId=94416770], val=[op=CREATE, val=CacheObjectImpl [val=null, hasValBytes=true]], prevVal=[op=NOOP, val=null], oldVal=[op=NOOP, val=null], entryProcessorsCol=null, ttl=-1, conflictExpireTime=-1, conflictVer=null, explicitVer=null, dhtVer=null, filters=[], filtersPassed=false, filtersSet=false, entry=GridDhtCacheEntry [rdrs=[], part=694, super=GridDistributedCacheEntry [super=GridCacheMapEntry [key=org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=16030069, hash=-1228408719, id=1, name=KeyObject1], val=null, startVer=1501212673290, ver=GridCacheVersion [topVer=112692678, order=1501212673290, nodeOrder=1], hash=-1228408719, extras=GridCacheMvccEntryExtras [mvcc=GridCacheMvcc [locs=[GridCacheMvccCandidate [nodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, ver=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], threadId=846, id=520, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], reentry=null, otherNodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, otherVer=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], mappedDhtNodes=null, mappedNearNodes=null, ownerVer=null, serOrder=null, key=org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=16030069, hash=-1228408719, id=1, name=KeyObject1], masks=local=1|owner=1|ready=1|reentry=0|used=0|tx=1|single_implicit=0|dht_local=1|near_local=0|removed=0|read=0, prevVer=null, nextVer=null], GridCacheMvccCandidate [nodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, ver=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], threadId=847, id=521, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], reentry=null, otherNodeId=d005de76-4378-4cd5-ad7e-f00593a00002, otherVer=GridCacheVersion [topVer=112692678, order=1501212673293, nodeOrder=3], mappedDhtNodes=null, mappedNearNodes=null, ownerVer=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], serOrder=null, key=org.apache.ignite.internal.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=16030069, hash=-1228408719, id=1, name=KeyObject1], masks=local=1|owner=0|ready=1|reentry=0|used=0|tx=1|single_implicit=0|dht_local=1|near_local=0|removed=0|read=0, prevVer=null, nextVer=null]], rmts=null]], flags=2]]], prepared=1, locked=false, nodeId=null, locMapped=false, expiryPlc=null, transferExpiryPlc=false, flags=0, partUpdateCntr=0, serReadVer=null, xidVer=null]]], super=IgniteTxAdapter [xidVer=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], writeVer=null, implicit=false, loc=true, threadId=847, startTime=1501212712015, nodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, startVer=GridCacheVersion [topVer=112692678, order=1501212673314, nodeOrder=1], endVer=null, isolation=REPEATABLE_READ, concurrency=OPTIMISTIC, timeout=800, sysInvalidate=false, sys=false, plc=2, commitVer=null, finalizing=NONE, invalidParts=null, state=PREPARING, timedOut=false, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], duration=808ms, onePhaseCommit=false], size=1]]]]
    at org.apache.ignite.internal.processors.cache.distributed.dht.GridDhtTxPrepareFuture$PrepareTimeoutObject.onTimeout(GridDhtTxPrepareFuture.java:1871)
    at org.apache.ignite.internal.processors.timeout.GridTimeoutProcessor$TimeoutWorker.body(GridTimeoutProcessor.java:159)
    at org.apache.ignite.internal.util.worker.GridWorker.run(GridWorker.java:110)
    at java.lang.Thread.run(Thread.java:745)
[2017-07-28 03:31:52,829][ERROR][sys-stripe-11-#193%transactions.TxOptimisticDeadlockDetectionTest3%][IgniteTxHandler] Failed to prepare DHT transaction: GridDhtTxLocal [nearNodeId=5d1c593f-e7b8-4672-9a3f-ff75dfe00000, nearFutId=dab9f378d51-37ca90c9-03f5-417c-9731-2c29810e3cc0, nearMiniId=2, nearFinFutId=null, nearFinMiniId=0, nearXidVer=GridCacheVersion [topVer=112692678, order=1501212673287, nodeOrder=1], super=GridDhtTxLocalAdapter [nearOnOriginatingNode=false, nearNodes=[], dhtNodes=[62f7789c-6ef8-44c1-8e05-c509bcf00001], explicitLock=false, super=IgniteTxLocalAdapter [completedBase=null, sndTransformedVals=false, depEnabled=false, txState=IgniteTxStateImpl [activeCacheIds=GridIntList [idx=1, arr=[94416770]], recovery=false, txMap=[IgniteTxEntry [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=629269478, hash=-2081639035, id=115, name=KeyObject115], cacheId=94416770, txKey=IgniteTxKey [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=629269478, hash=-2081639035, id=115, name=KeyObject115], cacheId=94416770], val=[op=CREATE, val=CacheObjectImpl [val=null, hasValBytes=true]], prevVal=[op=NOOP, val=null], oldVal=[op=NOOP, val=null], entryProcessorsCol=null, ttl=-1, conflictExpireTime=-1, conflictVer=null, explicitVer=null, dhtVer=null, filters=[], filtersPassed=false, filtersSet=false, entry=GridDhtCacheEntry [rdrs=[], part=617, super=GridDistributedCacheEntry [super=GridCacheMapEntry [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=629269478, hash=-2081639035, id=115, name=KeyObject115], val=null, startVer=1501212673302, ver=GridCacheVersion [topVer=112692678, order=1501212673302, nodeOrder=4], hash=-2081639035, extras=GridCacheObsoleteEntryExtras [obsoleteVer=GridCacheVersion [topVer=2147483647, order=0, nodeOrder=0]], flags=0]]], prepared=0, locked=false, nodeId=null, locMapped=false, expiryPlc=null, transferExpiryPlc=false, flags=0, partUpdateCntr=0, serReadVer=null, xidVer=null], IgniteTxEntry [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=1922638918, hash=-534233642, id=102, name=KeyObject102], cacheId=94416770, txKey=IgniteTxKey [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=1922638918, hash=-534233642, id=102, name=KeyObject102], cacheId=94416770], val=[op=CREATE, val=CacheObjectImpl [val=null, hasValBytes=true]], prevVal=[op=NOOP, val=null], oldVal=[op=NOOP, val=null], entryProcessorsCol=null, ttl=-1, conflictExpireTime=-1, conflictVer=null, explicitVer=null, dhtVer=null, filters=[], filtersPassed=false, filtersSet=false, entry=GridDhtCacheEntry [rdrs=[], part=510, super=GridDistributedCacheEntry [super=GridCacheMapEntry [key=o.a.i.i.processors.cache.transactions.TxOptimisticDeadlockDetectionTest$KeyObject [idHash=1922638918, hash=-534233642, id=102, name=KeyObject102], val=null, startVer=1501212673300, ver=GridCacheVersion [topVer=112692678, order=1501212673300, nodeOrder=4], hash=-534233642, extras=GridCacheObsoleteEntryExtras [obsoleteVer=GridCacheVersion [topVer=2147483647, order=0, nodeOrder=0]], flags=2]]], prepared=1, locked=false, nodeId=null, locMapped=false, expiryPlc=null, transferExpiryPlc=false, flags=0, partUpdateCntr=0, serReadVer=null, xidVer=null]]], super=IgniteTxAdapter [xidVer=GridCacheVersion [topVer=112692678, order=1501212673299, nodeOrder=4], writeVer=GridCacheVersion [topVer=112692678, order=1501212673301, nodeOrder=4], implicit=false, loc=true, threadId=846, startTime=1501212712015, nodeId=0fe34947-e728-4a41-84c0-3da5d5600003, startVer=GridCacheVersion [topVer=112692678, order=1501212673299, nodeOrder=4], endVer=null, isolation=REPEATABLE_READ, concurrency=OPTIMISTIC, timeout=790, sysInvalidate=false, sys=false, plc=2, commitVer=GridCacheVersion [topVer=112692678, order=1501212673299, nodeOrder=4], finalizing=NONE, invalidParts=null, state=ROLLED_BACK, timedOut=false, topVer=AffinityTopologyVersion [topVer=8, minorTopVer=8], duration=808ms, onePhaseCommit=false], size=2]]]
class org.apache.ignite.internal.transactions.IgniteTxTimeoutCheckedException: Transaction timed out: GridCacheSharedManagerAdapter [starting=true, stop=false]
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxManager.prepareTx(IgniteTxManager.java:824)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxLocalAdapter.userPrepare(IgniteTxLocalAdapter.java:425)
    at org.apache.ignite.internal.processors.cache.distributed.dht.GridDhtTxLocal.prepareAsync(GridDhtTxLocal.java:402)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxHandler.prepareNearTx(IgniteTxHandler.java:459)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxHandler.processNearTxPrepareRequest(IgniteTxHandler.java:121)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxHandler.access$000(IgniteTxHandler.java:95)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxHandler$1.apply(IgniteTxHandler.java:141)
    at org.apache.ignite.internal.processors.cache.transactions.IgniteTxHandler$1.apply(IgniteTxHandler.java:139)
    at org.apache.ignite.internal.processors.cache.GridCacheIoManager.processMessage(GridCacheIoManager.java:1042)
    at org.apache.ignite.internal.processors.cache.GridCacheIoManager.onMessage0(GridCacheIoManager.java:561)
    at org.apache.ignite.internal.processors.cache.GridCacheIoManager.handleMessage(GridCacheIoManager.java:378)
    at org.apache.ignite.internal.processors.cache.GridCacheIoManager.handleMessage(GridCacheIoManager.java:304)
    at org.apache.ignite.internal.processors.cache.GridCacheIoManager.access$100(GridCacheIoManager.java:99)
    at org.apache.ignite.internal.processors.cache.GridCacheIoManager$1.onMessage(GridCacheIoManager.java:293)
    at org.apache.ignite.internal.managers.communication.GridIoManager.invokeListener(GridIoManager.java:1556)
    at org.apache.ignite.internal.managers.communication.GridIoManager.processRegularMessage0(GridIoManager.java:1184)
    at org.apache.ignite.internal.managers.communication.GridIoManager.access$4200(GridIoManager.java:126)
    at org.apache.ignite.internal.managers.communication.GridIoManager$9.run(GridIoManager.java:1097)
    at org.apache.ignite.internal.util.StripedExecutor$Stripe.run(StripedExecutor.java:483)
    at java.lang.Thread.run(Thread.java:745)
{noformat}
