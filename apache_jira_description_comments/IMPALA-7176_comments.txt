[~kwho] Assigned to you because you don't have many broken-build JIRAs. Free free to reassign.

Sorry I misclicked

Sorry for not getting back to this earlier. There doesn't seem to be a product bug here. It was mostly a slightly flaky test which led to slightly longer than expected (60s) time for all fragments to finish due to non-determinism on how fast a fragment instance communicates with the coordinator and notices a cancellation. Since this hasn't happened for a while, I will hold off from bumping the timeout limit at this point. If it happens again in the future, please consider bumping the timeout limit to 90 seconds. Details below:

The query which failed was:
{noformat}
query_test/test_insert.py::TestInsertQueries::test_insert_mem_limit[compression_codec: gzip | exec_option: {'sync_ddl': 1, 'batch_size': 0, 'num_nodes': 0, 'disable_codegen_rows_threshold': 0, 'disable_codegen': False, 'abort_on_error': 1, 'debug_action': None, 'exec_single_node_rows_threshold': 0} | table_format: parquet/none] FAILED
{noformat}
From the log file, the failing query has query id *{{1946493a28ec3cab:84bd1cdf00000000}}*, being served by frontend service thread with thread id *27308*
{noformat}
I0613 12:41:53.426910 27308 impala-beeswax-server.cc:54] query(): query=insert into table alltypesinsert
partition (year, month) /* +noclustered */
select at1.id, at1.bool_col, at1.tinyint_col, at1.smallint_col, at1.int_col, at1.bigint_col,
  at1.float_col, at1.double_col, at1.date_string_col, at1.string_col, at1.timestamp_col,
  at1.year, at2.id as month
from  functional.alltypes at1, functional.alltypes at2
I0613 12:41:53.426957 27308 impala-beeswax-server.cc:429] query: Query {
  01: query (string) = "insert into tabl[...](340)",
  03: configuration (list) = list<string>[8] {
    [0] = "DISABLE_CODEGEN_ROWS_THRESHOLD=0",
    [1] = "EXEC_SINGLE_NODE_ROWS_THRESHOLD=0",
    [2] = "BATCH_SIZE=0",
    [3] = "NUM_NODES=0",
    [4] = "SYNC_DDL=1",
    [5] = "DISABLE_CODEGEN=False",
    [6] = "ABORT_ON_ERROR=1",
    [7] = "COMPRESSION_CODEC=gzip",
  },
  04: hadoop_user (string) = "jenkins",
}


I0613 12:41:53.431267 27308 impala-server.cc:966] Registered query query_id=1946493a28ec3cab:84bd1cdf00000000 session_id=ea4203333981c117:4274b96a9f039bf
I0613 12:41:53.431725 27308 Frontend.java:945] Analyzing query: insert into table alltypesinsert
partition (year, month) /* +noclustered */
select at1.id, at1.bool_col, at1.tinyint_col, at1.smallint_col, at1.int_col, at1.bigint_col,
  at1.float_col, at1.double_col, at1.date_string_col, at1.string_col, at1.timestamp_col,
  at1.year, at2.id as month
from  functional.alltypes at1, functional.alltypes at2

E0613 12:41:54.480062 27329 krpc-data-stream-sender.cc:335] channel send to 127.0.0.1:27001 failed: (fragment_instance_id=1946493a28ec3cab:84bd1cdf00000007): Memory limit exceeded: Failed to allocate row batch
{noformat}
Searching in the log files, there were signs that all fragment instances exited eventually after the query failed due to exceeding mem limit. It's just that some of the fragments were a bit late in exiting:
{noformat}
I0613 12:42:55.971096 27317 query-exec-mgr.cc:155] ReleaseQueryState(): query_id=1946493a28ec3cab:84bd1cdf00000000 refcnt=1
I0613 12:42:56.723235 27319 query-exec-mgr.cc:155] ReleaseQueryState(): query_id=1946493a28ec3cab:84bd1cdf00000000 refcnt=1
I0613 12:42:57.066081 27318 query-exec-mgr.cc:155] ReleaseQueryState(): query_id=1946493a28ec3cab:84bd1cdf00000000 refcnt=1
{noformat}
The fact that subsequent iteration of {{test_insert_mem_limit}} succeeded also suggests that there were no stuck fragment instances as each of these tests carried out the same check of waiting for all fragment instances to go to 0.
{noformat}
query_test/test_insert.py::TestInsertQueries::test_insert_mem_limit[compression_codec: snappy | exec_option: {'sync_ddl': 1, 'batch_size': 0, 'num_nodes': 0, 'disable_codegen_rows_threshold': 0, 'disable_codegen': False, 'abort_on_error': 1, 'debug_action': None, 'exec_single_node_rows_threshold': 0} | table_format: parquet/none] PASSED
query_test/test_insert.py::TestInsertQueries::test_insert_mem_limit[compression_codec: none | exec_option: {'sync_ddl': 0, 'batch_size': 1, 'num_nodes': 0, 'disable_codegen_rows_threshold': 0, 'disable_codegen': True, 'abort_on_error': 1, 'debug_action': None, 'exec_single_node_rows_threshold': 0} | table_format: parquet/none] PASSED
query_test/test_insert.py::TestInsertQueries::test_insert_mem_limit[compression_codec: snappy | exec_option: {'sync_ddl': 0, 'batch_size': 0, 'num_nodes': 0, 'disable_codegen_rows_threshold': 0, 'disable_codegen': False, 'abort_on_error': 1, 'debug_action': None, 'exec_single_node_rows_threshold': 0} | table_format: parquet/none] PASSED
query_test/test_insert.py::TestInsertQueries::test_insert_mem_limit[compression_codec: gzip | exec_option: {'sync_ddl': 0, 'batch_size': 0, 'num_nodes': 0, 'disable_codegen_rows_threshold': 0, 'disable_codegen': True, 'abort_on_error': 1, 'debug_action': None, 'exec_single_node_rows_threshold': 0} | table_format: parquet/none] PASSED
{noformat}

Based on the analysis so far, this is mostly a test which is timing dependent. Given that we haven't seen this timeout or failure since last report in July, it seems safe to close this for now. If it happens again in the future and we again conclude that it's due to timing, we can consider bumping the timeout limit to a higher value. Please reopen if you disagree.

I saw this happening a few times again on CentOS6

Same story as before that a bunch of errors occur trying to close HDFS files.
{noformat}
I0506 03:25:27.867305  2376 impala-server.cc:1179] UnregisterQuery(): query_id=3f4e3729014920fd:6348d0a700000000
I0506 03:25:27.867316  2376 impala-server.cc:1286] Cancel(): query_id=3f4e3729014920fd:6348d0a700000000
I0506 03:26:46.128023 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1125528934_dir/year=2009/month=96/3f4e3729014920fd-6348d0a700000006_1599712631_data.0.parq
I0506 03:26:48.610034 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1116334753_dir/year=2009/month=90/3f4e3729014920fd-6348d0a700000006_1538863142_data.0.parq
I0506 03:26:49.798688 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1096964370_dir/year=2009/month=85/3f4e3729014920fd-6348d0a700000006_505853140_data.0.parq
I0506 03:26:51.065665 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_230483782_dir/year=2009/month=84/3f4e3729014920fd-6348d0a700000006_489483668_data.0.parq
I0506 03:26:52.847128 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_228522612_dir/year=2009/month=91/3f4e3729014920fd-6348d0a700000006_557428172_data.0.parq
I0506 03:26:53.735042 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1892991001_dir/year=2009/month=77/3f4e3729014920fd-6348d0a700000006_669120494_data.0.parq
I0506 03:26:54.193152 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1637597586_dir/year=2009/month=75/3f4e3729014920fd-6348d0a700000006_1880936814_data.0.parq
I0506 03:26:54.196121 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1269995654_dir/year=2009/month=73/3f4e3729014920fd-6348d0a700000006_164580709_data.0.parq
I0506 03:26:56.613723 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1257291759_dir/year=2009/month=71/3f4e3729014920fd-6348d0a700000006_619682508_data.0.parq
I0506 03:26:57.575908 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_288931087_dir/year=2009/month=80/3f4e3729014920fd-6348d0a700000006_1389400620_data.0.parq
I0506 03:26:57.946020 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1371190019_dir/year=2009/month=67/3f4e3729014920fd-6348d0a700000006_763165105_data.0.parq
I0506 03:26:58.940048 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_191610503_dir/year=2009/month=68/3f4e3729014920fd-6348d0a700000006_1618014383_data.0.parq
I0506 03:26:59.170779 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_538663445_dir/year=2009/month=65/3f4e3729014920fd-6348d0a700000006_837143117_data.0.parq
I0506 03:27:00.586366 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_441898772_dir/year=2009/month=57/3f4e3729014920fd-6348d0a700000006_97155194_data.0.parq
I0506 03:27:00.595664 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1493083733_dir/year=2009/month=49/3f4e3729014920fd-6348d0a700000006_383265752_data.0.parq
I0506 03:27:02.290900 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_2091786405_dir/year=2009/month=56/3f4e3729014920fd-6348d0a700000006_607480701_data.0.parq
I0506 03:27:02.470818 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_924989241_dir/year=2009/month=37/3f4e3729014920fd-6348d0a700000006_861173829_data.0.parq
I0506 03:27:02.889241 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_610941160_dir/year=2009/month=35/3f4e3729014920fd-6348d0a700000006_420155298_data.0.parq
I0506 03:27:03.132764 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1320593277_dir/year=2009/month=93/3f4e3729014920fd-6348d0a700000006_1654998198_data.0.parq
I0506 03:27:03.446030 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_584736007_dir/year=2009/month=74/3f4e3729014920fd-6348d0a700000006_776423757_data.0.parq
I0506 03:27:03.450269 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1666615646_dir/year=2009/month=29/3f4e3729014920fd-6348d0a700000006_650313146_data.0.parq
I0506 03:27:04.206543 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_743976315_dir/year=2009/month=50/3f4e3729014920fd-6348d0a700000006_1767294240_data.0.parq
I0506 03:27:05.118238 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1179006556_dir/year=2009/month=43/3f4e3729014920fd-6348d0a700000006_162863721_data.0.parq
I0506 03:27:05.267717 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_2043800535_dir/year=2009/month=76/3f4e3729014920fd-6348d0a700000006_1509725248_data.0.parq
I0506 03:27:05.893873 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1305015174_dir/year=2009/month=70/3f4e3729014920fd-6348d0a700000006_2143709015_data.0.parq
I0506 03:27:06.553614 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_428072004_dir/year=2009/month=24/3f4e3729014920fd-6348d0a700000006_1834484438_data.0.parq
I0506 03:27:07.104847 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1007049183_dir/year=2009/month=28/3f4e3729014920fd-6348d0a700000006_1261066392_data.0.parq
I0506 03:27:08.014575 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_772518996_dir/year=2009/month=20/3f4e3729014920fd-6348d0a700000006_1575929046_data.0.parq
I0506 03:27:08.266366 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_603008334_dir/year=2009/month=86/3f4e3729014920fd-6348d0a700000006_174786539_data.0.parq
I0506 03:27:08.903297 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1079350938_dir/year=2009/month=17/3f4e3729014920fd-6348d0a700000006_534046901_data.0.parq
I0506 03:27:08.905881 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_808745267_dir/year=2009/month=10/3f4e3729014920fd-6348d0a700000006_1744598879_data.0.parq
I0506 03:27:10.242847 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1595937998_dir/year=2009/month=97/3f4e3729014920fd-6348d0a700000006_1512203781_data.0.parq
I0506 03:27:10.298434 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_2101903486_dir/year=2009/month=60/3f4e3729014920fd-6348d0a700000006_941548214_data.0.parq
I0506 03:27:10.361604 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_395244345_dir/year=2009/month=7/3f4e3729014920fd-6348d0a700000006_2004748292_data.0.parq
I0506 03:27:10.366664 28538 runtime-state.cc:199] 3f4e3729014920fd:6348d0a700000006] Error from query 3f4e3729014920fd:6348d0a700000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_216922053_dir/year=2009/month=51/3f4e3729014920fd-6348d0a700000006_988566810_data.0.parq
I0506 03:27:12.123772 28538 query-exec-mgr.cc:184] 3f4e3729014920fd:6348d0a700000006] ReleaseQueryState(): deleted query_id=3f4e3729014920fd:6348d0a700000000
{noformat}

The error from HDFS was:
{noformat}
Error(2): No such file or directory
Root cause: RemoteException: File does not exist: /test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/3f4e3729014920fd_6348d0a700000000/.3f4e3729014920fd-6348d0a700000006_1116334753_dir/year=2009/month=90/3f4e3729014920fd-6348d0a700000006_1538863142_data.0.parq (inode 111416) [Lease.  Holder: DFSClient_NONMAPREDUCE_1345999117_1, pending creates: 237]
        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.checkLease(FSNamesystem.java:2782)
        at org.apache.hadoop.hdfs.server.namenode.FSDirWriteFileOp.analyzeFileState(FSDirWriteFileOp.java:599)
        at org.apache.hadoop.hdfs.server.namenode.FSDirWriteFileOp.validateAddBlock(FSDirWriteFileOp.java:171)
        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getAdditionalBlock(FSNamesystem.java:2661)
        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.addBlock(NameNodeRpcServer.java:872)
        at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.addBlock(ClientNamenodeProtocolServerSideTranslatorPB.java:550)
        at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)
        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:523)
        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:991)
        at org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:869)
        at org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:815)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:422)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1875)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2675)

{noformat}

In contrast, on a "normal" run on CentOS7, the gap between errors is much smaller:
{noformat}
I0507 06:00:28.546306  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1750786194_dir/year=2010/month=6698/604547d6c90d35cc-687829a300000007_1765864232_data.0.parq
I0507 06:00:28.558277  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1985043279_dir/year=2010/month=6406/604547d6c90d35cc-687829a300000007_1633071154_data.0.parq
I0507 06:00:28.559262  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1456538717_dir/year=2010/month=6998/604547d6c90d35cc-687829a300000007_254404050_data.0.parq
I0507 06:00:28.560215  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_2003521940_dir/year=2010/month=6697/604547d6c90d35cc-687829a300000007_1238532195_data.0.parq
I0507 06:00:28.561125  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_57964397_dir/year=2010/month=6392/604547d6c90d35cc-687829a300000007_1877906633_data.0.parq
I0507 06:00:28.562016  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_101748158_dir/year=2010/month=6395/604547d6c90d35cc-687829a300000007_1418522640_data.0.parq
I0507 06:00:28.562847  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1836045452_dir/year=2010/month=6387/604547d6c90d35cc-687829a300000007_1842394749_data.0.parq
I0507 06:00:28.563812  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1154726225_dir/year=2010/month=6707/604547d6c90d35cc-687829a300000007_18933374_data.0.parq
I0507 06:00:28.564685  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1562017200_dir/year=2010/month=6995/604547d6c90d35cc-687829a300000007_1743104725_data.0.parq
I0507 06:00:28.565524  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1984612015_dir/year=2010/month=6390/604547d6c90d35cc-687829a300000007_2093744698_data.0.parq
I0507 06:00:28.566606  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_507260971_dir/year=2010/month=7012/604547d6c90d35cc-687829a300000007_730893260_data.0.parq
I0507 06:00:28.567404  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_353743340_dir/year=2010/month=6992/604547d6c90d35cc-687829a300000007_1037788408_data.0.parq
I0507 06:00:28.568238  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_2000164600_dir/year=2010/month=6693/604547d6c90d35cc-687829a300000007_971421389_data.0.parq
I0507 06:00:28.569088  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_113972141_dir/year=2010/month=6400/604547d6c90d35cc-687829a300000007_75947755_data.0.parq
I0507 06:00:28.569928  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_392778644_dir/year=2010/month=6383/604547d6c90d35cc-687829a300000007_1657061712_data.0.parq
I0507 06:00:28.570734  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1594519469_dir/year=2010/month=6999/604547d6c90d35cc-687829a300000007_1021673465_data.0.parq
I0507 06:00:28.571544  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1544844556_dir/year=2010/month=6991/604547d6c90d35cc-687829a300000007_485378498_data.0.parq
I0507 06:00:28.572290  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_94923980_dir/year=2010/month=6393/604547d6c90d35cc-687829a300000007_1546739001_data.0.parq
I0507 06:00:28.573241  4620 runtime-state.cc:199] 604547d6c90d35cc:687829a300000007] Error from query 604547d6c90d35cc:687829a300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/604547d6c90d35cc_687829a300000000/.604547d6c90d35cc-687829a300000007_1709056226_dir/year=2010/month=6691/604547d6c90d35cc-687829a300000007_479232300_data.0.parq

{noformat}

Is it just that CentOS6 EC2 instance is slower in general as they aren't exactly the same instance type, right ?

I checked CentOS6 on a normal run and the bad run, and aside from that one query it doesn't look like it takes that long to close each file.
{noformat}
I0505 04:06:32.513451 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1013623373_dir/year=2010/month=3778/6941c52d861ccd92-4d0b5f6300000006_1785420667_data.0.parq
I0505 04:06:32.518699 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1031280706_dir/year=2010/month=3736/6941c52d861ccd92-4d0b5f6300000006_1157243783_data.0.parq
I0505 04:06:32.541903 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1500362349_dir/year=2010/month=3716/6941c52d861ccd92-4d0b5f6300000006_173922991_data.0.parq
I0505 04:06:32.691490 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1814632915_dir/year=2010/month=3758/6941c52d861ccd92-4d0b5f6300000006_1099157650_data.0.parq
I0505 04:06:32.731895 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_2036615500_dir/year=2010/month=3765/6941c52d861ccd92-4d0b5f6300000006_326876908_data.0.parq
I0505 04:06:32.777603 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_437271396_dir/year=2010/month=3712/6941c52d861ccd92-4d0b5f6300000006_2034645987_data.0.parq
I0505 04:06:32.870354 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1896288815_dir/year=2010/month=3705/6941c52d861ccd92-4d0b5f6300000006_1943909232_data.0.parq
I0505 04:06:32.975394 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1853756570_dir/year=2010/month=3702/6941c52d861ccd92-4d0b5f6300000006_1493516151_data.0.parq
I0505 04:06:32.980425 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_525641306_dir/year=2010/month=3759/6941c52d861ccd92-4d0b5f6300000006_726980076_data.0.parq
I0505 04:06:33.112517 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_353314624_dir/year=2010/month=3695/6941c52d861ccd92-4d0b5f6300000006_39048754_data.0.parq
I0505 04:06:33.232197 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_2044053756_dir/year=2010/month=3721/6941c52d861ccd92-4d0b5f6300000006_120198473_data.0.parq
I0505 04:06:33.328680 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1779356582_dir/year=2010/month=3687/6941c52d861ccd92-4d0b5f6300000006_1324746682_data.0.parq
I0505 04:06:33.440546 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_321878130_dir/year=2010/month=3683/6941c52d861ccd92-4d0b5f6300000006_1693794988_data.0.parq
I0505 04:06:33.499622 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1957447563_dir/year=2010/month=3670/6941c52d861ccd92-4d0b5f6300000006_715167180_data.0.parq
I0505 04:06:33.540843 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_433355676_dir/year=2010/month=3740/6941c52d861ccd92-4d0b5f6300000006_1119843434_data.0.parq
I0505 04:06:33.582803 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_123302492_dir/year=2010/month=3771/6941c52d861ccd92-4d0b5f6300000006_1229522001_data.0.parq
I0505 04:06:33.625893 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_835365653_dir/year=2010/month=3723/6941c52d861ccd92-4d0b5f6300000006_1941659159_data.0.parq
I0505 04:06:33.631115 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_398356034_dir/year=2010/month=3662/6941c52d861ccd92-4d0b5f6300000006_892918336_data.0.parq
I0505 04:06:33.701272 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1523249079_dir/year=2010/month=3763/6941c52d861ccd92-4d0b5f6300000006_543099349_data.0.parq
I0505 04:06:33.728605 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_713864023_dir/year=2010/month=3660/6941c52d861ccd92-4d0b5f6300000006_1613200010_data.0.parq
I0505 04:06:33.735168 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1948719250_dir/year=2010/month=3700/6941c52d861ccd92-4d0b5f6300000006_796269003_data.0.parq
I0505 04:06:33.760854 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_875950081_dir/year=2010/month=3699/6941c52d861ccd92-4d0b5f6300000006_1573967304_data.0.parq
I0505 04:06:33.784643 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_665801973_dir/year=2010/month=3691/6941c52d861ccd92-4d0b5f6300000006_1401305665_data.0.parq
I0505 04:06:33.825253 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1543303124_dir/year=2010/month=3720/6941c52d861ccd92-4d0b5f6300000006_1151135419_data.0.parq
I0505 04:06:33.830410 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_373665451_dir/year=2010/month=3753/6941c52d861ccd92-4d0b5f6300000006_1775584161_data.0.parq
I0505 04:06:33.953307 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_767319771_dir/year=2010/month=3661/6941c52d861ccd92-4d0b5f6300000006_1369380133_data.0.parq
I0505 04:06:34.036233 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_588746399_dir/year=2010/month=3659/6941c52d861ccd92-4d0b5f6300000006_653170024_data.0.parq
I0505 04:06:34.066857 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_138357172_dir/year=2010/month=3658/6941c52d861ccd92-4d0b5f6300000006_1936234656_data.0.parq
I0505 04:06:34.259788 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_744303455_dir/year=2010/month=3688/6941c52d861ccd92-4d0b5f6300000006_1423595541_data.0.parq
I0505 04:06:34.264747 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_2142673630_dir/year=2010/month=3655/6941c52d861ccd92-4d0b5f6300000006_1057487567_data.0.parq
I0505 04:06:34.333886 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1732660240_dir/year=2010/month=3706/6941c52d861ccd92-4d0b5f6300000006_1931585020_data.0.parq
I0505 04:06:34.525280 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_77828449_dir/year=2010/month=3656/6941c52d861ccd92-4d0b5f6300000006_402772664_data.0.parq
I0505 04:06:34.672421 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_1487970499_dir/year=2010/month=3727/6941c52d861ccd92-4d0b5f6300000006_1854017671_data.0.parq
I0505 04:06:34.693787 16364 runtime-state.cc:199] 6941c52d861ccd92:4d0b5f6300000006] Error from query 6941c52d861ccd92:4d0b5f6300000000: Failed to close HDFS file: hdfs://localhost:20500/test-warehouse/functional_parquet.db/alltypesinsert/_impala_insert_staging/6941c52d861ccd92_4d0b5f6300000000/.6941c52d861ccd92-4d0b5f6300000006_617566069_dir/year=2010/month=3652/6941c52d861ccd92-4d0b5f6300000006_374751946_data.0.parq
I0505 04:06:38.591276 16364 query-exec-mgr.cc:184] 6941c52d861ccd92:4d0b5f6300000006] ReleaseQueryState(): deleted query_id=6941c52d861ccd92:4d0b5f6300000000

{noformat}

One thing that's interesting is that it seems to be related to "pending creates" reported in the HDFS error. Maybe a red herring but maybe there's some reason why HDFS operations are slower.

Anyway, I started wondering why we were getting these errors. It looks like Coordinator::FinalizeHdfsInsert() deletes the staging directory as part of query teardown, which is reasonable enough. However, it's really suboptimal for the HdfsTableSink to go one-by-one through its files trying to close them when the entire directory has been removed from under it. I don't think we can avoid the need to call hdfsClose() on all the files, otherwise we'd have a bunch of open file handles. We could potentially do something like wait in the coordinator for a little bit to see if the executors clean up their staging directory.

Commit ed0a2b6010107c0719ca00991259298c59730a0b in impala's branch refs/heads/master from Michael Ho
[ https://gitbox.apache.org/repos/asf?p=impala.git;h=ed0a2b6 ]

IMPALA-7176: Increase wait time in test_insert_mem_limit

test_insert_mem_limit in test_insert.py will wait for all fragments
to exit before proceeding after the test query hits a memory limit.
On some slower EC2 instances with Centos6, the default wait time of
60s may occasionally cause the test to fail due to time out waiting
for all fragments to exit.

This change increases the timeout to 180 seconds.

Testing done:
- Looped test_insert_mem_limit for 100 times on Centos6;

Change-Id: I2e14bef79c6c6fb0004270319f1c491194260438
Reviewed-on: http://gerrit.cloudera.org:8080/13292
Reviewed-by: Impala Public Jenkins <impala-public-jenkins@cloudera.com>
Tested-by: Impala Public Jenkins <impala-public-jenkins@cloudera.com>


