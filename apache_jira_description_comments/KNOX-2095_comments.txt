Patch works locally on a custom version of knox. To use, adjust the gateway-site.xml to 1 (I.E. 1 ms). A 504 error should be returned instead of the usual 500 error.

[~jamchen] thanks this looks like it could be useful. Can you open a PR and add a test for this potentially? If this goes into a different catch block looks like don't audit though? There should be a better way to handle this.

Sounds good; I'll try setting up a test case. As for the "different catch block" issue, from testing the code, it seems that when a timeout occurs, the inboundResponse generated by "inboundResponse = getHttpClient().execute( outboundRequest );" under executeOutboundRequest is the call that fails during a socket timeout error, with the time gap before the error controlled by the gateway-site.xml file (The logic in between is a bit murky, but from what I've seen, it's not really possible to dig much deeper without going into the other Apache packages). I don't think a socket timeout would occur in a try-catch block other than this for purposes of accessing the Knox gateway, though admittedly I could be better informed on any other things that the socketTimeout parameter controls.

I do agree that this patch doesn't seem ideal and that there would optimally be a better way of handling this. I also haven't used Knox long enough to know whether or not other errors are masked as 500 errors, though I'd assume that there are some that exist. Complicating things is the fact that this particular fix doesn't go the failover nodes, while other errors that occur as a result of setting the inboundResponse may benefit from trying other failover nodes. Still, it'd be nice if we could distinguish 504 errors at least; I'll set up the PR after the test case(s) are written.

I managed to create a test case and have ant verify pass for the repository; unfortunately, I'm a bit new to Apache's Gitbox setup and am not entirely sure how to set up an account. Still looking into it, but I'd guess I don't have committer access based on [https://cwiki.apache.org/confluence/display/KNOX/Contribution+Process#ContributionProcess-1.Checkoutsourcecode].



Accordingly, I've created a new patch corresponding to my commits at KNOX-2095 in the attachments. I don't see any obvious way to set up a PR; is setting up a patch the right way to go about this?

https://cwiki.apache.org/confluence/display/KNOX/Contribution+Process#ContributionProcess-GithubWorkflow

^^^ The github workflow is what you are looking for. You shouldn't need an account on gitbox. The patch is making progress. I'll review it in more detail when there is a PR (easier to add comments).

Hi Kevin,

Sorry for the delay; for some reason I had thought the patch was for v1.2.0 and had been testing it against that. Currently, ant verify fails locally against Knox 1.4.0 when the patch is applied, but the master branch also locally fails on the same test so it's likely a transient error.

I believe you mentioned that you had some comments to make, so I've preemptively set up a PR atÂ [https://github.com/apache/knox/pull/177]. I'll update this post once ant verify succeeds.

EDIT: Both master and KNOX-2095 succeeded locally.

Best regards,

-James

Moving this out to 1.5.0 due to lack of movement.

