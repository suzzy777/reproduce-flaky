mbautin requested code review of "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: Kannan, Karthik, nspiegelberg, JIRA

  The hard-coded ZK client port has long been a problem for running HBase test suite in parallel. The mini ZK cluster should run on a random free port, and that port should be passed to all parts of the unit tests that need to talk to the mini cluster. In fact, randomizing the port exposes a lot of places in the code where a new configuration is instantiated, and as a result the client tries to talk to the default ZK client port and times out.

  The initial fix is for 0.89-fb, where it already allows to run unit tests in parallel in 10 minutes. A fix for the trunk will follow.


TEST PLAN
  Run unit tests. Deploy on a dev cluster.

REVISION DETAIL
  https://reviews.facebook.net/D255

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/avro/AvroServer.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/LoadIncrementalHFiles.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java
  src/main/java/org/apache/hadoop/hbase/master/ThrottledRegionReopener.java
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
  src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeperWrapper.java
  src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSink.java
  src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/HQuorumPeer.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWrapper.java
  src/main/ruby/hbase/admin.rb
  src/test/java/org/apache/hadoop/hbase/HBaseClusterTestCase.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestFullLogReconstruction.java
  src/test/java/org/apache/hadoop/hbase/TestMultiParallelPut.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/avro/TestAvroServer.java
  src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java
  src/test/java/org/apache/hadoop/hbase/loadtest/RegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/mapred/TestLegacyTableMapReduce.java
  src/test/java/org/apache/hadoop/hbase/mapred/TestTableMapReduce.java
  src/test/java/org/apache/hadoop/hbase/mapreduce/TestLoadIncrementalHFiles.java
  src/test/java/org/apache/hadoop/hbase/mapreduce/TestTableMapReduce.java
  src/test/java/org/apache/hadoop/hbase/master/TestMaster.java
  src/test/java/org/apache/hadoop/hbase/master/TestRegionManager.java
  src/test/java/org/apache/hadoop/hbase/regionserver/TestFSErrorsExposed.java
  src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionClose.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSink.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/rest/HBaseRESTClusterTestBase.java
  src/test/java/org/apache/hadoop/hbase/rest/client/TestRemoteTable.java
  src/test/java/org/apache/hadoop/hbase/thrift/TestThriftServer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/resources/hbase-site.xml
  src/test/ruby/shell/shell_test.rb

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/471/

Tip: use the X-Herald-Rules header to filter Herald messages in your client.


tedyu has commented on the revision "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".

INLINE COMMENTS
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java:64 How was 0xc000 chosen ?
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java:113 Should this be debug ?
  I imagine there would be many mini zookeeper clusters running in parallel on the build machine.
  src/main/java/org/apache/hadoop/hbase/client/HTable.java:90 Nice.
  We can mark this ctor deprecated in HBase 0.92.
  For HBase TRUNK, I think we should remove this ctor and the ctor on line 104.

REVISION DETAIL
  https://reviews.facebook.net/D255


mbautin requested code review of "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  This is similar to D255 but for HBase trunk. Making ZK client port random and fixing unit tests that fail because the port number is not being passed.

TEST PLAN
  Run unit tests. Deploy on a dev cluster.

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/525/

Tip: use the X-Herald-Rules header to filter Herald messages in your client.


@Mikhail:
Thanks for working overtime for producing TRUNK patch.

ThriftHBaseServiceHandler originally uses the default ctor (generated by compiler) which doesn't take Configuration.
The addition of new ctor hides that default ctor and results in:
{code}
[ERROR] /Users/zhihyu/trunk-hbase/src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java:[199,36] cannot find symbol
[ERROR] symbol  : constructor ThriftHBaseServiceHandler()
[ERROR] location: class org.apache.hadoop.hbase.thrift2.ThriftHBaseServiceHandler
{code}
I went over thrift2/ThriftServer.java and didn't find an easy way of plugging in Configuration parameter.

I suggest adding the argument-less ctor for ThriftHBaseServiceHandler.

Patch v2 for TRUNK.
I added parameter-less ctor for ThriftHBaseServiceHandler.

Patch testing.

tedyu has commented on the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".

INLINE COMMENTS
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java:117 Thanks for taking care of HBASE-4750.

REVISION DETAIL
  https://reviews.facebook.net/D279


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502644/4746-trunk-v2.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 39 new or modified tests.

    -1 javadoc.  The javadoc tool appears to have generated -164 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 48 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

     -1 core tests.  The patch failed these unit tests:
                       org.apache.hadoop.hbase.master.TestDistributedLogSplitting
                  org.apache.hadoop.hbase.replication.TestMasterReplication
                  org.apache.hadoop.hbase.replication.TestReplication
                  org.apache.hadoop.hbase.regionserver.TestColumnSeeking

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/193//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/193//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/193//console

This message is automatically generated.

mbautin updated the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  Fixed TestMasterReplication. 239 test classes run, 1096 tests succeeded, http://bit.ly/HBASE-4746. One test class without any methods (TestHLogUtils).

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502651/D279.2.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 39 new or modified tests.

    -1 javadoc.  The javadoc tool appears to have generated -164 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 48 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

     -1 core tests.  The patch failed these unit tests:
                       org.apache.hadoop.hbase.master.TestDistributedLogSplitting
                  org.apache.hadoop.hbase.coprocessor.TestRegionServerCoprocessorExceptionWithAbort
                  org.apache.hadoop.hbase.coprocessor.TestRegionServerCoprocessorExceptionWithRemove

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/195//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/195//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/195//console

This message is automatically generated.

+1 on D279 patch v2.

Nice work, Mikhail.

@Ted: how did you generate 4746-trunk-v2.txt? When diffing D279.2.patch against 4746-trunk-v2.txt, I get a lot of differences.
Can we use the D279.2.patch? The default ThriftHBaseServiceHandler constructor is not needed anymore in ThriftServer, because I instantiated the configuration in ThriftServer on constructor invocation. But if you think I should add the default constructor back (e.g. if it part of client API), please let me know and I will upload a D279.3.patch.

Thank you!
--Mikhail

@Mikhail:
I planned to use D279.2.patch since its patch testing results were clean.

Omitting default ThriftHBaseServiceHandler ctor is also good since the caller has to pass Configuration parameter.

I generated 4746-trunk-v2.txt by applying D279.1.patch, adding the default ctor and using 'svn diff ' command.

+1 on D279.2. Thanks for doing this Mikhail.

{code}
public int getRandomPort() {
  return 0xc000 + new Random().nextInt(0x3f00);
}
{code}
Could use a comment on the choice of values.

Why did the statics have to be removed from TestMasterReplication but not from TestReplication and TestMultislaveReplication (and I do apologize for the cut-and-pasting here)?


stack has accepted the revision "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".

  Very nice Mikhail.  Minor nits.  Please attach patch to JIRA so we can commit.  If you have a moment, perhaps address the above else we'll do it on commit.  Good stuff.

INLINE COMMENTS
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java:113 I'd think this log message rare since the port randomly chosen.  When it does happen, I think it should be noticeable so I'm fine w/ INFO.  DEBUG would work too.
  src/main/java/org/apache/hadoop/hbase/avro/AvroServer.java:142 Good
  src/main/java/org/apache/hadoop/hbase/client/HTable.java:90 +1
  src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java:200 Deprecate?
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:46 Why avro package stuff in here?
  src/test/resources/hbase-site.xml:128 Good catch.

REVISION DETAIL
  https://reviews.facebook.net/D255


mbautin has commented on the revision "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".

  Replying to Ted's comments (I just discovered I had some unpublished comment drafts on this diff sitting in Phabricator for a couple of days).

  Miguel: I will post another version of this patch to make it more consistent with D279 and address your review comments.

INLINE COMMENTS
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java:64 Ports from 49152 to 65535 cannot be registered with IANA and are intended for dynamic allocation (see http://bit.ly/dynports).
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java:113 OK, we can change this to debug. This has been an extremely useful debug message for me. Previously, when the ZK client port was always 21810 in tests (I think it is different in the trunk), I saw this message any time I got two instances of a mini-cluster unit test running on the same machine. However, the incremented port number was not communicated properly to all places where we cared about it, so the test failed. When I went back and re-ran the unit test on my local machine, it passed, of course. The whole purpose of this diff is to get rid of this flakiness. Now, with randomized port assignment, we should not see this message very often.

  Not sure how this is related to the log message, but yes, there will be many unit tests running their own mini ZK clusters on one machine, either being allocated to the same task tracker when running unit tests on MapReduce, or using parallel Maven test execution, or in any other way.

REVISION DETAIL
  https://reviews.facebook.net/D255


mbautin updated the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  Making follow-up changes after addressing Ted's and Miguel's comments from D255.

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502699/D279.3.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 39 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/200//console

This message is automatically generated.

mbautin updated the revision "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: Kannan, Karthik, nspiegelberg, JIRA, stack

  Making this diff more consistent with D279, and addressing Ted's and Miguel's comments. The only unit tests that fail are TestReplication, TestFullLogReconstruction, and TestZooKeeper, but these failures have existed for a while and Liyin is working on a fix for those. The time to run the test suite is consistently under 10 minutes.

REVISION DETAIL
  https://reviews.facebook.net/D255

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/avro/AvroServer.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/LoadIncrementalHFiles.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java
  src/main/java/org/apache/hadoop/hbase/master/ThrottledRegionReopener.java
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
  src/main/java/org/apache/hadoop/hbase/replication/ReplicationZookeeperWrapper.java
  src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSink.java
  src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/HQuorumPeer.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWrapper.java
  src/main/ruby/hbase/admin.rb
  src/test/java/org/apache/hadoop/hbase/HBaseClusterTestCase.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestFullLogReconstruction.java
  src/test/java/org/apache/hadoop/hbase/TestMultiParallelPut.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/avro/TestAvroServer.java
  src/test/java/org/apache/hadoop/hbase/client/TestAdmin.java
  src/test/java/org/apache/hadoop/hbase/loadtest/RegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/mapred/TestLegacyTableMapReduce.java
  src/test/java/org/apache/hadoop/hbase/mapred/TestTableMapReduce.java
  src/test/java/org/apache/hadoop/hbase/mapreduce/TestLoadIncrementalHFiles.java
  src/test/java/org/apache/hadoop/hbase/mapreduce/TestTableMapReduce.java
  src/test/java/org/apache/hadoop/hbase/master/TestMaster.java
  src/test/java/org/apache/hadoop/hbase/master/TestRegionManager.java
  src/test/java/org/apache/hadoop/hbase/regionserver/TestFSErrorsExposed.java
  src/test/java/org/apache/hadoop/hbase/regionserver/TestHRegionClose.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSink.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/rest/HBaseRESTClusterTestBase.java
  src/test/java/org/apache/hadoop/hbase/rest/client/TestRemoteTable.java
  src/test/java/org/apache/hadoop/hbase/thrift/TestThriftServer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/resources/hbase-site.xml
  src/test/ruby/shell/shell_test.rb


mbautin has commented on the revision "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".

INLINE COMMENTS
  src/main/java/org/apache/hadoop/hbase/thrift/ThriftServer.java:200 Removed this constructor.

REVISION DETAIL
  https://reviews.facebook.net/D255


mbautin has commented on the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".

  An update on unit test runs:

  Run 1: 239 test classes run, 1092 tests, 16 min 13 sec. TestRegionServerCoprocessorExceptionWithAbort failed but succeeded when rerun locally
  Run 2: 239 test classes run, 1096 tests, 9 min 39 sec, no failures.

  I will look into the discrepancy between the number of tests in these two cases -- but I think this is because the MapReduce framework can run the same task multiple times ("speculative execution"). So I guess we are good to do with this patch.

REVISION DETAIL
  https://reviews.facebook.net/D279


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502700/D255.2.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 77 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/201//console

This message is automatically generated.

mbautin has commented on the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".

  Actually, I just found a potential bug that affects command-line invocations of HMaster -- will upload a new diff shortly. Sorry for so many emails.

REVISION DETAIL
  https://reviews.facebook.net/D279


mbautin updated the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  Addressing the problems with running HMaster from the command line. Also fixing intermittent issues with TestRegionServerCoprocessorExceptionWithAbort and TestRegionServerCoprocessorExceptionWithRemove. 1096 tests in 239 classes succeeded.

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithAbort.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithRemove.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502707/D279.4.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 45 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/202//console

This message is automatically generated.

mbautin updated the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  Follow-up cleanup to TestRegionServerCoprocessorExceptionWithRemove.

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithAbort.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithRemove.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502708/D279.5.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 45 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/203//console

This message is automatically generated.

Changes to FSTableDescriptors.java are already in TRUNK.

Patch testing v5.

-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502710/D279-trunk-v5.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 45 new or modified tests.

    -1 javadoc.  The javadoc tool appears to have generated -164 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 51 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/204//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/204//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/204//console

This message is automatically generated.

mbautin updated the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  Rebasing on recent fixes in the trunk.

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  CHANGES.txt
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/AggregateImplementation.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/AggregateProtocol.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/BaseEndpointCoprocessor.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/ipc/CoprocessorProtocol.java
  src/main/java/org/apache/hadoop/hbase/ipc/HBaseClient.java
  src/main/java/org/apache/hadoop/hbase/ipc/HBaseServer.java
  src/main/java/org/apache/hadoop/hbase/ipc/Invocation.java
  src/main/java/org/apache/hadoop/hbase/ipc/ProtocolSignature.java
  src/main/java/org/apache/hadoop/hbase/ipc/Status.java
  src/main/java/org/apache/hadoop/hbase/ipc/VersionedProtocol.java
  src/main/java/org/apache/hadoop/hbase/ipc/WritableRpcEngine.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMaster.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithAbort.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithRemove.java
  src/test/java/org/apache/hadoop/hbase/ipc/TestDelayedRpc.java
  src/test/java/org/apache/hadoop/hbase/regionserver/TestServerCustomProtocol.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


mbautin updated the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".
Reviewers: tedyu, JIRA

  Please ignore the previous update, some unrelated changes got into the patch. Creating a new patch that applies on top of the trunk. Sorry for spam.

REVISION DETAIL
  https://reviews.facebook.net/D279

AFFECTED FILES
  src/main/java/org/apache/hadoop/hbase/HConstants.java
  src/main/java/org/apache/hadoop/hbase/client/HTable.java
  src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
  src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
  src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
  src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
  src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
  src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
  src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
  src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
  src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
  src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithAbort.java
  src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithRemove.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
  src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
  src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
  src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
  src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
  src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502713/D279.7.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 45 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/205//console

This message is automatically generated.

Same as D279.v7

-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12502724/D279-trunk-v7.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 45 new or modified tests.

    -1 javadoc.  The javadoc tool appears to have generated -164 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 51 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/207//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/207//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/207//console

This message is automatically generated.

Integrated to TRUNK.

Thanks for the patch Mikhail.

Thanks for the review Stack.

@Ted: thanks for fixing the part of the patch that did not apply (I have no idea why). I think D279-trunk-v7.txt is ready to be committed.

Never mind my last comment :) got an update as I was writing it. Thanks a lot Ted and Stack!

@Ted & @Stack: since we've decided to allow more Metadata in our commit logs, it would be nice to use the patch comments when committing this diff.  Namely, including 'Differential Revision: #' will allow Phabricator to automatically mark the review as closed.

Integrated in HBase-TRUNK #2418 (See [https://builds.apache.org/job/HBase-TRUNK/2418/])
    HBASE-4746  Use a random ZK client port in unit tests so we can run them in parallel
               (Mikhail Bautin)

tedyu : 
Files : 
* /hbase/trunk/CHANGES.txt
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/HConstants.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HTable.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/coprocessor/CoprocessorHost.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/mapreduce/TableOutputFormat.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMasterCommandLine.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/thrift2/ThriftHBaseServiceHandler.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/thrift2/ThriftServer.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/util/RegionSplitter.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/MiniZooKeeperCluster.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKConfig.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/TestHBaseTestingUtility.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/TestZooKeeper.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithAbort.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithRemove.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestMasterReplication.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestMultiSlaveReplication.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/TestReplication.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/thrift2/TestThriftHBaseServiceHandler.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/util/TestMergeTool.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/util/TestRegionSplitter.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperMainServerArg.java


I will integrate the patch for TestRegionServerCoprocessorExceptionWithXXX to 0.92

As recently as 
https://builds.apache.org/view/G-L/view/HBase/job/HBase-0.92/113/console, the test failed.

Integrated in HBase-0.92 #118 (See [https://builds.apache.org/job/HBase-0.92/118/])
    HBASE-4746  Fix TestRegionServerCoprocessorExceptionWithXXX (Mikhail Bautin)

tedyu : 
Files : 
* /hbase/branches/0.92/CHANGES.txt
* /hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithAbort.java
* /hbase/branches/0.92/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionServerCoprocessorExceptionWithRemove.java


> Why did the statics have to be removed from TestMasterReplication but not from TestReplication and TestMultislaveReplication (and I do apologize for the cut-and-pasting here)?

@Lars: I am not sure why TestReplication and TestMultislveReplication worked fine without changing them to set up and tear down a mini cluster for every test. These tests are complex enough and sequential test methods were most likely stepping on each other's state in TestMasterReplication. I think it only makes sense to isolate test methods within a unit test.

@Nicolas ACK.  Will do next time.

mbautin has abandoned the revision "[jira] [HBASE-4746] Use a random ZK client port in unit tests so we can run them in parallel".

  This was committed into trunk (thanks Ted), abandoning this diff.  A reminder to committers (quoting Nicolas) so that we don't have to abandon good revisions in the future:

  > since we've decided to allow more Metadata in our commit logs, it would be nice to use the patch comments when committing this diff. Namely, including 'Differential Revision: #' will allow Phabricator to automatically mark the review as closed.

REVISION DETAIL
  https://reviews.facebook.net/D279


mbautin has abandoned the revision "[jira] [HBASE-4746] [89-fb] Use a random ZK client port in unit tests so we can run them in parallel".

  This was committed into 89-fb, abandoning revision.

REVISION DETAIL
  https://reviews.facebook.net/D255


