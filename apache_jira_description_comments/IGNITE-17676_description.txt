"execute" method registers a future that doesn't wait for heartbeat event, making tests flaky. The easiest way to fix it is changing class itself. Writing tests that consider this race condition is close to impossible