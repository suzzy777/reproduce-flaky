Commit 1bd45d295ebfc3f526a98eebb9b61525b9332c91 in impala's branch refs/heads/master from Tim Armstrong
[ https://gitbox.apache.org/repos/asf?p=impala.git;h=1bd45d2 ]

IMPALA-9381: on-demand conversion of runtime profile

Converting the runtime profile to JSON and text representations
at the end of the query used significant CPU and time. These
representations will commonly never be accessed, because
they need to be explicitly requested by a client via the
HTTP debug interface or via a thrift profile request.
So it is a waste of resources to eagerly convert them, and
in particular it is a bad idea to do so on the critical path
of a query.

This commit switches to generating alternative profile
representations on-demand. Only the compressed thrift version
of the profile is stored in QueryStateRecord. This is the
most compact representation of the profile and it is
relatively convenient to convert into other formats.

Also use a move() when constructing QueryStateRecord to avoid
copying the profile unnecessarily.

Fix a couple of potential use-after-free issues where Json
objects generated by RuntimeProfile::ToJson() could reference
strings owned by the object pool. These were detected by
running an ASAN build, because after this change, the temporary
object pool used to hold the deserialized profile was freed before
the JSON tree was returned.

The "kind" field of counters is removed from the JSON profile.
This couldn't be round-tripped correctly through thrift, and
probably isn't necessary. It also helps slim down the profiles.

Also make sure to preserve the "indent" field when round-tripping
to thrift.

Testing:
Ran core tests.

Diffed JSON and text profiles download from web UI from before and
after to make sure there were no unexpected changes as a result
of the round-trip via thrift.

Change-Id: Ic2f5133cc146adc3b044cf4b64aae0a9688449fa
Reviewed-on: http://gerrit.cloudera.org:8080/15236
Reviewed-by: Impala Public Jenkins <impala-public-jenkins@cloudera.com>
Tested-by: Impala Public Jenkins <impala-public-jenkins@cloudera.com>


Commit a89b14ddec14cb05831f63cd26c862f536b08e8f in impala's branch refs/heads/master from Tim Armstrong
[ https://gitbox.apache.org/repos/asf?p=impala.git;h=a89b14d ]

IMPALA-9751: increase query log size to 100

This is both a flaky test fix and a change to the default.
I believe the test was flaky because queries had been
aged out of the log before the exec summary was fetched.

We have also found in production that queries often
age out of the log quickly, so the default size can
be too small.

IMPALA-9381 reduces the size of the query log entries,
so hopefully means that the total query log size won't
be significantly larger.

Change-Id: I70a1f8195574287f5df048c13f4a79acd88a81b3
Reviewed-on: http://gerrit.cloudera.org:8080/15972
Reviewed-by: Impala Public Jenkins <impala-public-jenkins@cloudera.com>
Tested-by: Impala Public Jenkins <impala-public-jenkins@cloudera.com>


